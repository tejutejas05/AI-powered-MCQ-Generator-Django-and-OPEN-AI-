{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MCQ GENERATOR</title>
    <link rel="stylesheet" href="{% static 'generator/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Righteous&display=swap" rel="stylesheet">
</head>
<body>
    
    <center><h2>AI MCQ GENERATOR</h2></center>
    <br>
    <br>
    <br>
    <div class="form">
    <form method="GET" action="/generate/">

        <label>Topic: </label><br>
        <input type="text" name="topic" required><br><br>

        <label>Difficulty: </label>
        <select name="difficulty">
            <option value="easy">EASY</option>
            <option value="medium">MEDIUM</option>
            <option value="HARD">HARD</option>
        </select><br>

        <label for="">Number of Questions: </label><br>
        <input type="number" name="num_questions" min="1" max="20" value="5"><br>

        <button type="submit">GENERATE MCQ'S</button>

    </form>
    </div>
    <div id="loading" class="loading-box" style="display:none;">
    <div class="spinner"></div>
    <p>Generating MCQs… Please wait</p>
    </div>
    <br>
    <br>
    <br>


    <h2>Generated MCQs</h2>
    <div id="mcq-container"></div>

  <script>
let currentMCQs = [];

const form = document.querySelector("form");
const loading = document.getElementById("loading");
const submitBtn = form.querySelector("button");

form.addEventListener("submit", function(e) {
    e.preventDefault();

    const topic = form.topic.value;
    const difficulty = form.difficulty.value;
    const num_questions = form.num_questions.value;

    const url = `/generate/?topic=${topic}&difficulty=${difficulty}&num_questions=${num_questions}`;

    const container = document.getElementById("mcq-container");

    // ✅ SHOW LOADER
    loading.style.display = "block";
    submitBtn.disabled = true;
    submitBtn.innerText = "Generating...";
    container.innerHTML = "";

    fetch(url)
    .then(res => res.json())
    .then(data => {

        // ✅ HIDE LOADER
        loading.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.innerText = "Generate MCQs";

        if (!data.mcqs) {
            alert("Server error. Try again.");
            return;
        }

        container.innerHTML = "";

        // ✅ If response is structured JSON
        if (Array.isArray(data.mcqs)) {

            currentMCQs = data.mcqs;

            data.mcqs.forEach((mcq, index) => {

                let output = `<div class="question-box">`;
                output += `<div class="question-title">Q${index+1}: ${mcq.question}</div>`;

                mcq.options.forEach(opt => {
                    output += `<div class="option">${opt}</div>`;
                });

                output += `<div class="answer">Answer: ${mcq.answer}</div>`;
                output += `</div>`;

                container.innerHTML += output;
            });
        }

        // ✅ If response is plain text
        else {

            const questions = data.mcqs.split("\n\n");
            currentMCQs = questions;

            let output = "";

            questions.forEach(q => {
                const lines = q.split("\n");

                output += `<div class="question-box">`;

                lines.forEach(line => {

                    if(line.startsWith("Q"))
                        output += `<div class="question-title">${line}</div>`;
                    else if(line.startsWith("Answer"))
                        output += `<div class="answer">${line}</div>`;
                    else
                        output += `<div class="option">${line}</div>`;
                });

                output += `</div>`;
            });

            container.innerHTML = output;
        }

    })
    .catch(err => {
        loading.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.innerText = "Generate MCQs";
        console.log("Error:", err);
        alert("Something went wrong!");
    });
});



function downloadPDF() {

    if (!currentMCQs || currentMCQs.length === 0) {
        alert("Generate MCQs first!");
        return;
    }

    fetch("/download/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: "mcqs=" + JSON.stringify(currentMCQs)
    })
    .then(response => response.blob())
    .then(blob => {
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "MCQs.pdf";
        link.click();
    })
    .catch(err => console.log("Download error:", err));
}



function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
    }
    return cookieValue;
}
</script>
<button onclick="downloadPDF()">Download PDF</button>


</body>
</html>